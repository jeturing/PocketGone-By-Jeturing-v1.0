import React, { useState, useEffect } from 'react';
import { Shield, Wifi, WifiOff, Target, Key, Zap, Terminal, Loader2, CheckCircle2, XCircle, AlertTriangle } from 'lucide-react';
import { WirelessInterface, PentestTools, AttackSession } from '../types';

const API_URL = 'http://localhost:8000';

export const PentestView: React.FC = () => {
  const [interfaces, setInterfaces] = useState<WirelessInterface[]>([]);
  const [tools, setTools] = useState<PentestTools | null>(null);
  const [selectedInterface, setSelectedInterface] = useState<string>('');
  const [networks, setNetworks] = useState<any[]>([]);
  const [selectedNetwork, setSelectedNetwork] = useState<any>(null);
  const [loading, setLoading] = useState(false);
  const [scanning, setScanning] = useState(false);
  const [activeSession, setActiveSession] = useState<AttackSession | null>(null);
  const [output, setOutput] = useState<string[]>([]);
  const [attackHistory, setAttackHistory] = useState<any[]>([]);

  useEffect(() => {
    loadToolsAndInterfaces();
    loadAttackHistory();
  }, []);

  const loadToolsAndInterfaces = async () => {
    try {
      const res = await fetch(`${API_URL}/api/pentest/tools`);
      const data = await res.json();
      setTools(data.tools);
      setInterfaces(data.interfaces);
      if (data.interfaces.length > 0) {
        setSelectedInterface(data.interfaces[0].name);
      }
    } catch (err) {
      console.error('Failed to load tools:', err);
    }
  };

  const loadAttackHistory = async () => {
    try {
      const res = await fetch(`${API_URL}/api/pentest/attack-history`);
      const data = await res.json();
      setAttackHistory(data.attacks || []);
    } catch (err) {
      console.error('Failed to load history:', err);
    }
  };

  const toggleMonitorMode = async () => {
    if (!selectedInterface) return;
    setLoading(true);
    try {
      const iface = interfaces.find(i => i.name === selectedInterface);
      const enable = !iface?.monitor_mode;
      
      const res = await fetch(`${API_URL}/api/pentest/monitor-mode`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ interface: selectedInterface, enable })
      });
      
      if (res.ok) {
        const data = await res.json();
        addOutput(`Monitor mode ${enable ? 'enabled' : 'disabled'}: ${data.message}`, 'success');
        loadToolsAndInterfaces();
      } else {
        addOutput('Failed to toggle monitor mode', 'error');
      }
    } catch (err) {
      addOutput(`Error: ${err}`, 'error');
    }
    setLoading(false);
  };

  const scanNetworks = async () => {
    if (!selectedInterface) return;
    setScanning(true);
    setNetworks([]);
    addOutput('Scanning networks...', 'info');
    
    try {
      const res = await fetch(`${API_URL}/api/pentest/scan-networks`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ interface: selectedInterface, duration: 10 })
      });
      
      if (res.ok) {
        const data = await res.json();
        setNetworks(data.networks || []);
        addOutput(`Found ${data.count} networks`, 'success');
      } else {
        addOutput('Scan failed', 'error');
      }
    } catch (err) {
      addOutput(`Error: ${err}`, 'error');
    }
    setScanning(false);
  };

  const deauthAttack = async () => {
    if (!selectedNetwork) return;
    setLoading(true);
    addOutput(`Launching deauth attack on ${selectedNetwork.ssid}...`, 'info');
    
    try {
      const res = await fetch(`${API_URL}/api/pentest/deauth-attack`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          interface: selectedInterface,
          target_bssid: selectedNetwork.bssid,
          count: 10
        })
      });
      
      if (res.ok) {
        addOutput('Deauth attack completed', 'success');
        loadAttackHistory();
      } else {
        addOutput('Deauth attack failed', 'error');
      }
    } catch (err) {
      addOutput(`Error: ${err}`, 'error');
    }
    setLoading(false);
  };

  const captureHandshake = async () => {
    if (!selectedNetwork) return;
    setLoading(true);
    addOutput(`Capturing handshake from ${selectedNetwork.ssid}...`, 'info');
    
    try {
      const res = await fetch(`${API_URL}/api/pentest/capture-handshake`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          interface: selectedInterface,
          target_bssid: selectedNetwork.bssid,
          channel: selectedNetwork.channel,
          duration: 60
        })
      });
      
      if (res.ok) {
        const data = await res.json();
        addOutput(data.success ? `Handshake captured: ${data.file}` : data.message, data.success ? 'success' : 'error');
        loadAttackHistory();
      } else {
        addOutput('Handshake capture failed', 'error');
      }
    } catch (err) {
      addOutput(`Error: ${err}`, 'error');
    }
    setLoading(false);
  };

  const wpsAttack = async () => {
    if (!selectedNetwork) return;
    setLoading(true);
    addOutput(`Launching WPS attack on ${selectedNetwork.ssid}...`, 'info');
    
    try {
      const res = await fetch(`${API_URL}/api/pentest/wps-attack`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          interface: selectedInterface,
          target_bssid: selectedNetwork.bssid,
          channel: selectedNetwork.channel
        })
      });
      
      if (res.ok) {
        const data = await res.json();
        setActiveSession({ session_id: data.session_id, status: 'running', tool_name: 'reaver' });
        addOutput(`WPS attack started (session: ${data.session_id})`, 'success');
      } else {
        addOutput('WPS attack failed', 'error');
      }
    } catch (err) {
      addOutput(`Error: ${err}`, 'error');
    }
    setLoading(false);
  };

  const wifiteAttack = async () => {
    setLoading(true);
    addOutput('Launching Wifite automated attack...', 'info');
    
    try {
      const res = await fetch(`${API_URL}/api/pentest/wifite-attack`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          interface: selectedInterface,
          target_bssid: selectedNetwork?.bssid
        })
      });
      
      if (res.ok) {
        const data = await res.json();
        setActiveSession({ session_id: data.session_id, status: 'running', tool_name: 'wifite' });
        addOutput(`Wifite started (session: ${data.session_id})`, 'success');
      } else {
        addOutput('Wifite failed', 'error');
      }
    } catch (err) {
      addOutput(`Error: ${err}`, 'error');
    }
    setLoading(false);
  };

  const stopSession = async () => {
    if (!activeSession) return;
    setLoading(true);
    
    try {
      const res = await fetch(`${API_URL}/api/pentest/stop-session/${activeSession.session_id}`, {
        method: 'POST'
      });
      
      if (res.ok) {
        addOutput('Session stopped', 'success');
        setActiveSession(null);
      } else {
        addOutput('Failed to stop session', 'error');
      }
    } catch (err) {
      addOutput(`Error: ${err}`, 'error');
    }
    setLoading(false);
  };

  const addOutput = (text: string, type: 'info' | 'success' | 'error' = 'info') => {
    const timestamp = new Date().toLocaleTimeString();
    const prefix = type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ';
    setOutput(prev => [`[${timestamp}] ${prefix} ${text}`, ...prev].slice(0, 50));
  };

  const interfaceInMonitorMode = interfaces.find(i => i.name === selectedInterface)?.monitor_mode;

  return (
    <div className="max-w-7xl mx-auto space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-3xl font-bold text-white mb-1">WiFi Pentesting Tools</h2>
          <p className="text-slate-400">Real Kali Linux tools with visual interface</p>
        </div>
        <div className="flex items-center gap-2 px-4 py-2 bg-red-500/20 border border-red-500/50 rounded-lg">
          <AlertTriangle className="text-red-400" size={20} />
          <span className="text-red-200 text-sm font-bold">Authorized Use Only</span>
        </div>
      </div>

      {/* Interface Selection */}
      <div className="bg-rf-panel border border-slate-700 rounded-lg p-6">
        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
          <Wifi size={20} className="text-rf-accent" />
          Wireless Interface
        </h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold text-slate-300 mb-2">Select Interface</label>
            <select
              value={selectedInterface}
              onChange={(e) => setSelectedInterface(e.target.value)}
              className="w-full bg-slate-900 border border-slate-700 rounded p-2 text-white"
            >
              {interfaces.map(iface => (
                <option key={iface.name} value={iface.name}>
                  {iface.name} - {iface.mac} ({iface.status})
                </option>
              ))}
            </select>
          </div>
          <div className="flex items-end">
            <button
              onClick={toggleMonitorMode}
              disabled={loading || !selectedInterface}
              className={`w-full flex items-center justify-center gap-2 px-4 py-2 rounded font-bold transition-all ${
                interfaceInMonitorMode
                  ? 'bg-green-600 hover:bg-green-700 text-white'
                  : 'bg-orange-600 hover:bg-orange-700 text-white'
              } disabled:opacity-50 disabled:cursor-not-allowed`}
            >
              {loading ? <Loader2 className="animate-spin" size={20} /> : interfaceInMonitorMode ? <CheckCircle2 size={20} /> : <WifiOff size={20} />}
              {interfaceInMonitorMode ? 'Monitor Mode ON' : 'Enable Monitor Mode'}
            </button>
          </div>
        </div>
      </div>

      {/* Network Scanning */}
      <div className="bg-rf-panel border border-slate-700 rounded-lg p-6">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold text-white flex items-center gap-2">
            <Target size={20} className="text-rf-accent" />
            Network Scanner
          </h3>
          <button
            onClick={scanNetworks}
            disabled={scanning || !interfaceInMonitorMode}
            className="flex items-center gap-2 px-4 py-2 bg-rf-accent hover:bg-rf-accent/80 text-slate-900 rounded font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {scanning ? <Loader2 className="animate-spin" size={20} /> : <Zap size={20} />}
            {scanning ? 'Scanning...' : 'Scan Networks'}
          </button>
        </div>
        
        {networks.length > 0 && (
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="bg-slate-800">
                <tr className="text-left">
                  <th className="p-3 font-bold text-slate-300">SSID</th>
                  <th className="p-3 font-bold text-slate-300">BSSID</th>
                  <th className="p-3 font-bold text-slate-300">Channel</th>
                  <th className="p-3 font-bold text-slate-300">Signal</th>
                  <th className="p-3 font-bold text-slate-300">Encryption</th>
                  <th className="p-3 font-bold text-slate-300">Actions</th>
                </tr>
              </thead>
              <tbody>
                {networks.map((net, idx) => (
                  <tr
                    key={idx}
                    className={`border-t border-slate-700 hover:bg-slate-800/50 cursor-pointer ${
                      selectedNetwork?.bssid === net.bssid ? 'bg-slate-800' : ''
                    }`}
                    onClick={() => setSelectedNetwork(net)}
                  >
                    <td className="p-3 text-white font-mono">{net.ssid || '<hidden>'}</td>
                    <td className="p-3 text-slate-400 font-mono text-xs">{net.bssid}</td>
                    <td className="p-3 text-slate-300">{net.channel}</td>
                    <td className="p-3 text-slate-300">{net.rssi} dBm</td>
                    <td className="p-3 text-slate-300">{net.encryption}</td>
                    <td className="p-3">
                      {selectedNetwork?.bssid === net.bssid && (
                        <span className="text-rf-accent text-xs font-bold">SELECTED</span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Attack Options */}
      {selectedNetwork && (
        <div className="bg-rf-panel border border-slate-700 rounded-lg p-6">
          <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
            <Shield size={20} className="text-red-400" />
            Attack Options for {selectedNetwork.ssid || selectedNetwork.bssid}
          </h3>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button
              onClick={deauthAttack}
              disabled={loading || activeSession !== null}
              className="flex flex-col items-center gap-2 p-4 bg-red-600/20 hover:bg-red-600/30 border border-red-600/50 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <WifiOff size={32} className="text-red-400" />
              <span className="text-white font-bold">Deauth Attack</span>
              <span className="text-xs text-slate-400">Disconnect clients</span>
            </button>
            
            <button
              onClick={captureHandshake}
              disabled={loading || activeSession !== null}
              className="flex flex-col items-center gap-2 p-4 bg-blue-600/20 hover:bg-blue-600/30 border border-blue-600/50 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <Key size={32} className="text-blue-400" />
              <span className="text-white font-bold">Capture Handshake</span>
              <span className="text-xs text-slate-400">WPA/WPA2</span>
            </button>
            
            <button
              onClick={wpsAttack}
              disabled={loading || activeSession !== null}
              className="flex flex-col items-center gap-2 p-4 bg-orange-600/20 hover:bg-orange-600/30 border border-orange-600/50 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <Zap size={32} className="text-orange-400" />
              <span className="text-white font-bold">WPS Attack</span>
              <span className="text-xs text-slate-400">Reaver PIN</span>
            </button>
            
            <button
              onClick={wifiteAttack}
              disabled={loading || activeSession !== null}
              className="flex flex-col items-center gap-2 p-4 bg-purple-600/20 hover:bg-purple-600/30 border border-purple-600/50 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <Terminal size={32} className="text-purple-400" />
              <span className="text-white font-bold">Wifite Auto</span>
              <span className="text-xs text-slate-400">Automated</span>
            </button>
          </div>
          
          {activeSession && (
            <div className="mt-4 p-4 bg-yellow-500/20 border border-yellow-500/50 rounded-lg">
              <div className="flex justify-between items-center">
                <div>
                  <p className="text-yellow-200 font-bold">Attack in Progress</p>
                  <p className="text-yellow-300/70 text-sm">Session: {activeSession.session_id}</p>
                </div>
                <button
                  onClick={stopSession}
                  className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded font-bold"
                >
                  Stop Attack
                </button>
              </div>
            </div>
          )}
        </div>
      )}

      {/* Output Console */}
      <div className="bg-rf-panel border border-slate-700 rounded-lg p-6">
        <h3 className="text-xl font-bold text-white mb-4">Console Output</h3>
        <div className="bg-slate-900 rounded p-4 h-64 overflow-y-auto font-mono text-sm">
          {output.length === 0 ? (
            <p className="text-slate-500">No output yet...</p>
          ) : (
            output.map((line, idx) => (
              <div
                key={idx}
                className={`mb-1 ${
                  line.includes('✓') ? 'text-green-400' :
                  line.includes('✗') ? 'text-red-400' :
                  'text-slate-300'
                }`}
              >
                {line}
              </div>
            ))
          )}
        </div>
      </div>

      {/* Attack History */}
      {attackHistory.length > 0 && (
        <div className="bg-rf-panel border border-slate-700 rounded-lg p-6">
          <h3 className="text-xl font-bold text-white mb-4">Recent Attacks</h3>
          <div className="space-y-2">
            {attackHistory.slice(0, 5).map((attack) => (
              <div key={attack.id} className="p-3 bg-slate-800 rounded flex justify-between items-center">
                <div>
                  <p className="text-white font-bold">{attack.attack_type.toUpperCase()} - {attack.target_bssid}</p>
                  <p className="text-slate-400 text-sm">{attack.notes}</p>
                </div>
                <div className={`px-3 py-1 rounded text-sm font-bold ${
                  attack.success ? 'bg-green-600/20 text-green-400' : 'bg-red-600/20 text-red-400'
                }`}>
                  {attack.success ? 'SUCCESS' : 'FAILED'}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};
